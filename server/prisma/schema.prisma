generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Connection URL provided via prisma.config.ts (datasource.url)
}

enum Role {
  CUSTOMER
  RESTAURANT
  RIDER
  ADMIN
}

enum AccountStatus {
  PENDING
  ACTIVE
  REJECTED
  SUSPENDED
}

enum VehicleType {
  BIKE
  CAR
  BICYCLE
  SCOOTER
}

model User {
  id                Int      @id @default(autoincrement())
  email             String   @unique
  password          String
  name              String
  phone             String?
  role              Role     @default(CUSTOMER)
  emailVerified     Boolean  @default(false)
  verificationToken String?
  tokenExpiry       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  restaurant        Restaurant?
  restaurantProfile RestaurantProfile?
  rider             Rider?
  riderProfile      RiderProfile?
  orders            Order[]
}

model Restaurant {
  id        Int      @id @default(autoincrement())
  ownerId   Int      @unique
  name      String
  address   String
  lat       Float?
  lng       Float?
  approved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner     User       @relation(fields: [ownerId], references: [id])
  menuItems MenuItem[]
  orders    Order[]
  notifications AdminNotification[] @relation("RestaurantAdminNotifications")
}

model MenuItem {
  id           Int      @id @default(autoincrement())
  restaurantId Int
  name         String
  description  String?
  priceCents   Int
  currency     String   @default("BDT")
  available    Boolean  @default(true)
  tags         String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  restaurant Restaurant  @relation(fields: [restaurantId], references: [id])
  dishIndex  DishIndex?
  orderItems OrderItem[]
}

model DishIndex {
  id         Int    @id @default(autoincrement())
  menuItemId Int    @unique
  name       String
  keywords   String[]
  priceCents Int
  rating     Float  @default(0)

  menuItem MenuItem @relation(fields: [menuItemId], references: [id])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  ASSIGNED
  PICKED_UP
  DELIVERED
  CANCELLED
}

model Order {
  id           Int         @id @default(autoincrement())
  userId       Int
  restaurantId Int
  riderId      Int?
  status       OrderStatus @default(PENDING)
  totalCents   Int
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  user       User        @relation(fields: [userId], references: [id])
  restaurant Restaurant  @relation(fields: [restaurantId], references: [id])
  rider      Rider?      @relation(fields: [riderId], references: [id])
  items      OrderItem[]
  payment    Payment?
}

model OrderItem {
  id         Int    @id @default(autoincrement())
  orderId    Int
  menuItemId Int
  quantity   Int
  priceCents Int

  order    Order    @relation(fields: [orderId], references: [id])
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])
}

model Rider {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  status    String   @default("OFFLINE") // OFFLINE, IDLE, BUSY
  lat       Float?
  lng       Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User    @relation(fields: [userId], references: [id])
  deliveries Order[]
}

model Payment {
  id            Int      @id @default(autoincrement())
  orderId       Int      @unique
  transactionId String?
  amountCents   Int
  status        String   @default("PENDING") // PENDING, COMPLETED, FAILED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id])
}

// New models for multi-role signup
model RestaurantProfile {
  id              Int           @id @default(autoincrement())
  userId          Int           @unique
  businessName    String
  address         String
  lat             Float?
  lng             Float?
  cuisine         String[]
  openingHours    Json?
  taxId           String?
  deliveryOptions String[]
  storefrontImage String?       // Cloudinary URL for storefront picture
  status          AccountStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user      User       @relation(fields: [userId], references: [id])
  documents Document[]
}

model RiderProfile {
  id               Int           @id @default(autoincrement())
  userId           Int           @unique
  vehicleType      VehicleType
  vehicleNumber    String?
  drivingLicense   String?
  insurance        String?
  availableRegions String[]
  availableHours   Json?
  status           AccountStatus @default(PENDING)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  user      User       @relation(fields: [userId], references: [id])
  documents Document[]
}

model Document {
  id             Int                @id @default(autoincrement())
  type           String             // business_license, driving_license, insurance, logo, etc.
  filename       String
  url            String
  uploadedAt     DateTime           @default(now())
  restaurantId   Int?
  riderId        Int?
  restaurant     RestaurantProfile? @relation(fields: [restaurantId], references: [id])
  rider          RiderProfile?      @relation(fields: [riderId], references: [id])
}

model AdminNotification {
  id           Int         @id @default(autoincrement())
  type         String
  title        String
  message      String
  read         Boolean     @default(false)
  restaurantId Int?
  restaurant   Restaurant? @relation(name: "RestaurantAdminNotifications", fields: [restaurantId], references: [id])
  metadata     Json?
  createdAt    DateTime    @default(now())
}
